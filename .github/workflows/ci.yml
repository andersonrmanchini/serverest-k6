name: CI - k6 Performance Tests

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
      fail-fast: true

    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ”§ Install k6
        run: |
          curl -s https://dl.k6.io/key.gpg | gpg --dearmor | sudo tee /usr/share/keyrings/k6-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Lint & Build
        run: |
          npm run build 2>/dev/null || true
          echo "Build completed (errors ignored if TypeScript-only)"

      - name: ðŸ”¥ Run Smoke Test (Quick Validation)
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://serverest.dev' }}
          K6_PROJECT_ID: ${{ secrets.K6_PROJECT_ID || '0' }}
          INSECURE_SKIP_TLS_VERIFY: ${{ secrets.INSECURE_SKIP_TLS_VERIFY || 'true' }}
          CI_ENVIRONMENT: true
        run: npm run build && k6 run dist/tests/index.js -e TEST_TYPE=smoke --out json=test-results/results-smoke.json
        continue-on-error: false

      - name: ðŸ“Š Run Load Test (Normal Load)
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://serverest.dev' }}
          K6_PROJECT_ID: ${{ secrets.K6_PROJECT_ID || '0' }}
          INSECURE_SKIP_TLS_VERIFY: ${{ secrets.INSECURE_SKIP_TLS_VERIFY || 'true' }}
          CI_ENVIRONMENT: true
        run: npm run build && k6 run dist/tests/index.js -e TEST_TYPE=load --out json=test-results/results-load.json
        continue-on-error: false

      - name: ðŸ”¥ Run Stress Test (Find Limits)
        if: github.ref == 'refs/heads/develop' && github.event_name != 'pull_request'
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://serverest.dev' }}
          K6_PROJECT_ID: ${{ secrets.K6_PROJECT_ID || '0' }}
          INSECURE_SKIP_TLS_VERIFY: ${{ secrets.INSECURE_SKIP_TLS_VERIFY || 'true' }}
          CI_ENVIRONMENT: true
        run: npm run build && k6 run dist/tests/index.js -e TEST_TYPE=stress --out json=test-results/results-stress.json
        continue-on-error: true

      - name: âš¡ Run Spike Test (Sudden Traffic)
        if: github.ref == 'refs/heads/develop' && github.event_name != 'pull_request'
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://serverest.dev' }}
          K6_PROJECT_ID: ${{ secrets.K6_PROJECT_ID || '0' }}
          INSECURE_SKIP_TLS_VERIFY: ${{ secrets.INSECURE_SKIP_TLS_VERIFY || 'true' }}
          CI_ENVIRONMENT: true
        run: npm run build && k6 run dist/tests/index.js -e TEST_TYPE=spike --out json=test-results/results-spike.json
        continue-on-error: true

      - name: ðŸ“„ Generate Smoke Report
        if: always()
        run: node scripts/generate-detailed-report.js test-results/results-smoke.json test-results/report-smoke.html smoke
        continue-on-error: true

      - name: ðŸ“„ Generate Load Report
        if: always()
        run: node scripts/generate-detailed-report.js test-results/results-load.json test-results/report-load.html load
        continue-on-error: true

      - name: ðŸ“„ Generate Stress Report
        if: github.ref == 'refs/heads/develop' && github.event_name != 'pull_request' && always()
        run: node scripts/generate-detailed-report.js test-results/results-stress.json test-results/report-stress.html stress
        continue-on-error: true

      - name: ðŸ“„ Generate Spike Report
        if: github.ref == 'refs/heads/develop' && github.event_name != 'pull_request' && always()
        run: node scripts/generate-detailed-report.js test-results/results-spike.json test-results/report-spike.html spike
        continue-on-error: true

      - name: ðŸ“¤ Upload test results and reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-test-results-${{ matrix.node-version }}
          path: test-results/
          retention-days: 30

      - name: ðŸ’¬ Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const fs = require('fs');
              const smokeFile = 'test-results/results-smoke.json';
              const loadFile = 'test-results/results-load.json';
              
              let comment = '## âœ… k6 Performance Tests Results\n\n';
              
              // Smoke Test Results
              if (fs.existsSync(smokeFile)) {
                const smokeResults = JSON.parse(fs.readFileSync(smokeFile, 'utf8'));
                const smokeSummary = smokeResults.metrics || {};
                
                comment += '### ðŸ”¥ Smoke Test (Quick Validation)\n\n';
                comment += '| Metric | Value |\n';
                comment += '|--------|-------|\n';
                
                if (smokeSummary.http_reqs?.value) {
                  comment += `| Total Requests | ${smokeSummary.http_reqs.value} |\n`;
                }
                if (smokeSummary.http_req_duration?.values?.p95) {
                  comment += `| P95 Duration | ${smokeSummary.http_req_duration.values.p95.toFixed(2)}ms |\n`;
                }
                if (smokeSummary.http_req_failed?.rate !== undefined) {
                  comment += `| Failed Rate | ${(smokeSummary.http_req_failed.rate * 100).toFixed(2)}% |\n`;
                }
                comment += '\n';
              }
              
              // Load Test Results
              if (fs.existsSync(loadFile)) {
                const loadResults = JSON.parse(fs.readFileSync(loadFile, 'utf8'));
                const loadSummary = loadResults.metrics || {};
                
                comment += '### ðŸ“Š Load Test (Normal Load)\n\n';
                comment += '| Metric | Value |\n';
                comment += '|--------|-------|\n';
                
                if (loadSummary.http_reqs?.value) {
                  comment += `| Total Requests | ${loadSummary.http_reqs.value} |\n`;
                }
                if (loadSummary.http_req_duration?.values?.p95) {
                  comment += `| P95 Duration | ${loadSummary.http_req_duration.values.p95.toFixed(2)}ms |\n`;
                }
                if (loadSummary.http_req_failed?.rate !== undefined) {
                  comment += `| Failed Rate | ${(loadSummary.http_req_failed.rate * 100).toFixed(2)}% |\n`;
                }
                comment += '\n';
              }
              
              comment += 'âœ… Tests passed - Ready for merge!';
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not post PR comment:', error.message);
            }
        continue-on-error: true

      - name: ðŸš¨ Check test status
        if: github.event_name == 'pull_request' && failure()
        run: |
          echo "::error::Performance tests failed - PR cannot be merged"
          echo "Check artifact and logs above for details"
          exit 1
